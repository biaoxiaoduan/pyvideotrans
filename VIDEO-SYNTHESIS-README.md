# 视频合成功能说明

## 功能概述

在`/view/taskid`页面上新增了"合成视频"按钮，可以将TTS生成的人声音频与原视频合成，使用Demucs分离原视频人声，保留背景音乐。

## 功能特点

- 🎬 **智能视频合成**: 使用Demucs分离原视频人声，保留背景音乐
- 🎵 **TTS音频生成**: 根据字幕内容生成高质量人声音频
- 🔗 **音频混合**: 将背景音乐和TTS音频智能混合
- ⏰ **时间精确对齐**: 根据SRT时间轴精确合成音频
- 🎛️ **实时进度显示**: 显示合成进度和状态

## 技术流程

### 1. 视频音频提取
- 从原视频中提取音频轨道
- 转换为16kHz采样率

### 2. Demucs人声分离
- 使用Demucs AI模型分离人声和背景音乐
- 保留背景音乐，去除原人声

### 3. TTS音频生成
- 根据字幕内容生成TTS人声音频
- 使用EdgeTTS引擎，支持多种音色

### 4. 音频时间对齐
- 按SRT时间轴精确对齐TTS音频
- 添加静音间隔确保时间同步

### 5. 音频混合
- 将背景音乐和TTS音频混合
- 使用FFmpeg的amix滤镜

### 6. 视频合成
- 将混合音频与原视频画面合成
- 输出最终的合成视频

## 使用方法

### 1. 访问字幕查看页面
访问 `http://localhost:9011/view/{task_id}` 页面

### 2. 点击合成视频按钮
在页面右上角找到橙色的"合成视频"按钮，点击开始合成

### 3. 等待合成完成
- 按钮会显示"合成中..."状态
- 系统会在后台处理视频和音频
- 合成完成后会弹出新窗口显示结果

### 4. 查看和下载结果
在结果页面可以：
- 在线播放合成的视频
- 下载视频文件
- 查看合成统计信息

## API接口

### 视频合成接口
- `POST /viewer_api/{task_id}/synthesize_video` - 启动视频合成任务
- `GET /synthesis_result/{task_id}` - 查看视频合成结果

### 请求参数
```json
{
  "subtitles": [
    {
      "line": 1,
      "start_time": 0,
      "end_time": 3000,
      "text": "字幕内容",
      "speaker": "说话人"
    }
  ]
}
```

## 依赖要求

### 必需工具
- **FFmpeg**: 音视频处理
- **Demucs**: 人声分离（可选，失败时使用原音频）

### Python包
- `edge-tts`: TTS音频生成
- `demucs`: 人声分离（需要安装）

## 安装Demucs

```bash
# 安装Demucs
pip install demucs

# 或者使用conda
conda install -c conda-forge demucs
```

## 文件结构

```
apidata/
├── {task_id}/                    # 原始任务目录
│   ├── video.mp4                 # 视频文件
│   └── subtitles.srt            # 字幕文件
└── synthesis_{task_id}_{timestamp}/  # 视频合成任务目录
    ├── synthesized_video_{timestamp}.mp4  # 合成视频
    └── result.json              # 任务结果信息
```

## 错误处理

### 常见问题

1. **Demucs分离失败**
   - 检查Demucs是否正确安装
   - 系统会自动降级使用原音频

2. **TTS生成失败**
   - 检查网络连接
   - 确认EdgeTTS服务可用

3. **音频混合失败**
   - 检查FFmpeg是否正确安装
   - 确认有足够的磁盘空间

4. **视频合成失败**
   - 检查原视频格式是否支持
   - 确认音频和视频时长匹配

## 性能优化

### 处理大量字幕
- 字幕数量过多时，建议分批处理
- 可以调整并发处理数量
- 监控内存使用情况

### 视频质量
- 默认保持原视频质量
- 可以调整音频编码参数
- 支持多种输出格式

## 配置选项

### TTS设置
```python
tts_item = {
    "role": "zh-CN-XiaoxiaoNeural",  # 音色
    "rate": "+0%",                   # 语速
    "volume": "+0%",                 # 音量
    "pitch": "+0Hz"                  # 音调
}
```

### 音频混合设置
```python
# FFmpeg混合参数
'-filter_complex', '[0:a][1:a]amix=inputs=2:duration=longest[mixed]'
'-c:a', 'aac',      # 音频编码
'-b:a', '128k'      # 音频比特率
```

## 测试

运行测试脚本验证功能：

```bash
python3 test_video_synthesis.py
```

## 注意事项

1. **网络要求**: EdgeTTS需要网络连接
2. **存储空间**: 确保有足够空间存储临时文件
3. **处理时间**: 视频合成可能需要较长时间
4. **浏览器兼容**: 建议使用现代浏览器

## 更新日志

- **v1.0.0**: 初始版本，支持基础视频合成功能
- 支持Demucs人声分离
- 支持TTS音频生成和混合
- 提供Web界面和API接口
